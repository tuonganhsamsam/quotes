<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T·ªïng H·ª£p C√¢u Tr√≠ch D·∫´n ‚Äì Sidebar Ph·∫£i & Nhi·ªÅu Ch·ªß ƒê·ªÅ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); min-height: 100vh; display: flex; }
    .main-container { display: flex; width: 100%; min-height: 100vh; }
    /* Sidebar b√™n ph·∫£i */
    .sidebar { position: fixed; right: 0; top: 0; width: 300px; height: 100vh; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 20px; overflow-y: auto; z-index: 100; }
    .content-area { flex: 1; padding: 20px; margin-right: 300px; }
    .sidebar-header { text-align: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e9ecef; }
    .sidebar-header h3 { color: #2c3e50; font-size: 1.3em; margin-bottom: 6px; }
    .sidebar-section { margin-bottom: 22px; }
    .sidebar-section h4 { color: #495057; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef; }
    .sidebar-btn { width: 100%; padding: 10px 12px; margin-top: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
    .sidebar-btn:hover { transform: translateX(-3px); box-shadow: -3px 3px 10px rgba(0,0,0,0.1); }
    .sidebar-btn-primary { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; }
    .sidebar-btn-secondary { background: #b8c6db; color: #2c3e50; }
    .sidebar-btn-success { background: #c8e6c9; color: #2e7d32; }
    .sidebar-btn-warning { background: #ffe0b2; color: #e65100; }
    .sidebar-btn-danger { background: #ffcdd2; color: #c62828; }
    .sidebar-btn-info { background: #e1f5fe; color: #0277bd; }
    .hidden-input { display: none; }
    .stats-sidebar { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 10px; padding: 16px; margin-bottom: 18px; }
    .stat-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; color: #2c3e50; }
    .stat-item:last-child { margin-bottom: 0; }
    .stat-label { font-size: 0.9em; font-weight: 500; }
    .stat-number { font-size: 1.1em; font-weight: bold; }
    label { display: block; font-weight: 600; color: #495057; font-size: 0.9em; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #a8edea; box-shadow: 0 0 0 3px rgba(168, 237, 234, 0.2); }
    textarea { resize: vertical; min-height: 100px; }
    /* Chips cho ch·ªß ƒë·ªÅ ƒë√£ ch·ªçn */
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .chip { background: #f1f3f5; border: 1px solid #e9ecef; border-radius: 16px; padding: 4px 8px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .chip button { border: none; background: transparent; cursor: pointer; font-weight: 700; color: #c62828; }
    .add-cat-row { display: flex; gap: 8px; margin-top: 6px; }
    .add-cat-row input { flex: 1; }
    .mini { font-size: 12px; color: #6c757d; margin-top: 4px; }
    /* N·ªôi dung ch√≠nh */
    .container { width: 100%; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); overflow: hidden; }
    .header { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; padding: 28px; text-align: center; }
    .header h1 { font-size: 2.2em; margin-bottom: 8px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    .header p { font-size: 1.05em; opacity: 0.85; margin-bottom: 16px; }
    /* N√∫t random trong header */
    .header-actions { margin-top: 16px; }
    .btn-random-header { background: rgba(255, 255, 255, 0.9); color: #2c3e50; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-random-header:hover { background: white; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .quotes-section { padding: 24px; }
    .quotes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .quotes-count { font-size: 1.05em; color: #6c757d; font-weight: 600; }
    .quotes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 18px; }
    .quote-card { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; position: relative; }
    .quote-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .quote-text { font-size: 1.1em; line-height: 1.6; color: #2c3e50; margin-bottom: 12px; font-style: italic; }
    .quote-meta { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .quote-source { font-weight: 600; color: #5e72e4; }
    .quote-category { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; display: inline-block; margin-right: 6px; }
    .quote-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
    .btn-small { padding: 6px 10px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .btn-small:hover { transform: translateY(-2px); }
    .btn-primary-small { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; }
    .btn-danger-small { background: #ffcdd2; color: #c62828; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: white; margin: 5% auto; padding: 24px; border-radius: 15px; width: 90%; max-width: 650px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e9ecef; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
    .close:hover { color: #000; }
    .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
    .empty-state h3 { margin-bottom: 10px; font-size: 1.5em; }
    .management-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 8px; background: #f8f9fa; }
    .management-item span { font-weight: 500; color: #495057; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; }
    .btn-danger { background: #ffcdd2; color: #c62828; }
    .btn:hover { transform: translateY(-2px); }
    /* Mobile */
    .mobile-menu-btn { position: fixed; top: 20px; right: 20px; z-index: 1002; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; }
    .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .mobile-overlay.show { display: block; }
    @media (max-width: 820px) {
      .content-area { margin-right: 0; padding: 10px; }
      .sidebar { position: fixed; right: -320px; width: 300px; transition: right 0.3s ease; z-index: 1001; }
      .sidebar.open { right: 0; }
      .mobile-menu-btn.show { display: block; }
      .quotes-grid { grid-template-columns: 1fr; }
      .modal-content { width: 95%; margin: 10% auto; padding: 20px; }
    }
  </style>
</head>
<body>
  <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar()" aria-label="M·ªü menu">‚ò∞</button>
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>
  <div class="main-container">
    <!-- N·ªôi dung b√™n tr√°i -->
    <div class="content-area">
      <div class="container">
        <div class="header">
          <h1>üìö T·ªïng H·ª£p C√¢u Tr√≠ch D·∫´n</h1>
          <p>L∆∞u tr·ªØ v√† qu·∫£n l√Ω nh·ªØng c√¢u tr√≠ch d·∫´n y√™u th√≠ch c·ªßa b·∫°n</p>
          <div class="header-actions">
            <button class="btn-random-header" onclick="showRandomQuotes()">
              <span>üé≤</span> Hi·ªÉn Th·ªã Ng·∫´u Nhi√™n
            </button>
          </div>
        </div>

        <div class="quotes-section">
          <div class="quotes-header">
            <div class="quotes-count" id="quotesCount">Hi·ªÉn th·ªã 0 c√¢u tr√≠ch d·∫´n</div>
          </div>
          <div class="quotes-grid" id="quotesGrid">
            <div class="empty-state">
              <div style="font-size: 4em; margin-bottom: 20px;">üìñ</div>
              <h3>Ch∆∞a c√≥ c√¢u tr√≠ch d·∫´n n√†o</h3>
              <p>H√£y th√™m c√¢u tr√≠ch d·∫´n ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar ph·∫£i -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>üéõÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</h3>
        <p style="font-size: 0.8em; color: #6c757d;">Nh·∫≠p & t√¨m ki·∫øm tr√≠ch d·∫´n</p>
      </div>

      <div class="stats-sidebar">
        <div class="stat-item"><span class="stat-label">üìù Tr√≠ch d·∫´n</span><span class="stat-number" id="totalQuotes">0</span></div>
        <div class="stat-item"><span class="stat-label">üè∑Ô∏è Ch·ªß ƒë·ªÅ</span><span class="stat-number" id="totalCategories">0</span></div>
        <div class="stat-item"><span class="stat-label">üìñ S√°ch</span><span class="stat-number" id="totalBooks">0</span></div>
      </div>

      <!-- Nh·∫≠p c√¢u tr√≠ch d·∫´n -->
      <div class="sidebar-section">
        <h4>Th√™m Tr√≠ch D·∫´n</h4>
        <div class="control-group">
          <label for="sideQuoteText">C√¢u tr√≠ch d·∫´n *</label>
          <textarea id="sideQuoteText" placeholder="Nh·∫≠p c√¢u tr√≠ch d·∫´n..." required></textarea>
        </div>
        <div class="control-group">
          <label for="sideBookName">T√™n s√°ch</label>
          <input type="text" id="sideBookName" placeholder="Nh·∫≠p t√™n s√°ch..." autocomplete="off" />
        </div>
        <div class="control-group">
          <label>Ch·ªß ƒë·ªÅ (nhi·ªÅu ch·ªß ƒë·ªÅ)</label>
          <div class="add-cat-row">
            <input type="text" id="sideCategoryInput" placeholder="Nh·∫≠p 1 ch·ªß ƒë·ªÅ r·ªìi b·∫•m + ho·∫∑c Enter" />
            <button class="btn btn-primary" id="addSideCatBtn">+</button>
          </div>
          <div class="mini">B·∫°n c√≥ th·ªÉ th√™m nhi·ªÅu ch·ªß ƒë·ªÅ. V√≠ d·ª•: Tri·∫øt h·ªçc, Cu·ªôc s·ªëng...</div>
          <div class="chips" id="sideSelectedCats"></div>
        </div>
        <button class="sidebar-btn sidebar-btn-primary" onclick="addQuote()"><span>‚ûï</span> Th√™m Tr√≠ch D·∫´n</button>
      </div>

      <!-- T√¨m ki·∫øm & l·ªçc -->
      <div class="sidebar-section">
        <h4>T√¨m Ki·∫øm & L·ªçc</h4>
        <div class="control-group">
          <label for="searchKeyword">T·ª´ kh√≥a</label>
          <input type="text" id="searchKeyword" placeholder="Nh·∫≠p t·ª´ kh√≥a..." />
        </div>
        <div class="control-group">
          <label for="filterCategories">L·ªçc theo ch·ªß ƒë·ªÅ (ch·ªçn nhi·ªÅu)</label>
          <select id="filterCategories" multiple size="6"></select>
        </div>
        <div class="control-group">
          <label for="filterBook">L·ªçc theo s√°ch</label>
          <select id="filterBook">
            <option value="">T·∫•t c·∫£ s√°ch</option>
          </select>
        </div>
        <button class="sidebar-btn sidebar-btn-primary" onclick="searchQuotes()"><span>üîç</span> T√¨m Ki·∫øm</button>
        <button class="sidebar-btn sidebar-btn-success" onclick="showAllQuotes()"><span>üìã</span> Hi·ªÉn Th·ªã T·∫•t C·∫£</button>
      </div>

      <!-- Qu·∫£n l√Ω -->
      <div class="sidebar-section">
        <h4>Qu·∫£n L√Ω</h4>
        <button class="sidebar-btn sidebar-btn-warning" onclick="openManageCategoriesModal()"><span>üè∑Ô∏è</span> Qu·∫£n L√Ω Ch·ªß ƒê·ªÅ</button>
        <button class="sidebar-btn sidebar-btn-info" onclick="openManageBooksModal()"><span>üìñ</span> Qu·∫£n L√Ω S√°ch</button>
      </div>

      <!-- D·ªØ li·ªáu -->
      <div class="sidebar-section">
        <h4>D·ªØ Li·ªáu</h4>
        <!-- NH·∫¨P XML -->
        <input type="file" class="hidden-input" id="importXMLInput" accept=".xml" onchange="importXMLData(event)" />
        <label for="importXMLInput" class="sidebar-btn sidebar-btn-secondary"><span>üìÅ</span> Nh·∫≠p XML</label>
        <!-- XU·∫§T XML -->
        <button class="sidebar-btn sidebar-btn-secondary" onclick="exportXMLData()"><span>üíæ</span> Xu·∫•t XML</button>
        <!-- NH·∫¨P TXT -->
        <input type="file" class="hidden-input" id="importTXTInput" accept=".txt" onchange="importTXTData(event)" />
        <label for="importTXTInput" class="sidebar-btn sidebar-btn-secondary"><span>üìÑ</span> Nh·∫≠p TXT</label>
        <!-- XU·∫§T TXT -->
        <button class="sidebar-btn sidebar-btn-secondary" onclick="exportTXTFullData()"><span>üìÑ</span> Xu·∫•t TXT (To√†n b·ªô)</button>
        <button class="sidebar-btn sidebar-btn-secondary" onclick="exportTXTData()"><span>üìë</span> Xu·∫•t TXT (Hi·ªÉn th·ªã)</button>
        <button class="sidebar-btn sidebar-btn-danger" onclick="clearAllData()"><span>üóëÔ∏è</span> X√≥a T·∫•t C·∫£</button>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="manageCategoriesModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="catTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="catTitle">üè∑Ô∏è Qu·∫£n L√Ω Ch·ªß ƒê·ªÅ</h2>
        <span class="close" onclick="closeManageCategoriesModal()" aria-label="ƒê√≥ng">&times;</span>
      </div>
      <div class="control-group" style="display:flex; gap:10px; align-items:flex-end;">
        <div style="flex:1;">
          <label for="newCategoryName">T√™n ch·ªß ƒë·ªÅ m·ªõi</label>
          <input type="text" id="newCategoryName" placeholder="Nh·∫≠p t√™n ch·ªß ƒë·ªÅ..." />
        </div>
        <button class="btn btn-primary" onclick="addCategory()">‚ûï Th√™m</button>
      </div>
      <div id="categoriesList"></div>
    </div>
  </div>

  <div id="manageBooksModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="bookTitle">üìñ Qu·∫£n L√Ω S√°ch</h2>
        <span class="close" onclick="closeManageBooksModal()" aria-label="ƒê√≥ng">&times;</span>
      </div>
      <div class="control-group" style="display:flex; gap:10px; align-items:flex-end;">
        <div style="flex:1;">
          <label for="newBookName">T√™n s√°ch m·ªõi</label>
          <input type="text" id="newBookName" placeholder="Nh·∫≠p t√™n s√°ch..." />
        </div>
        <button class="btn btn-primary" onclick="addBook()">‚ûï Th√™m</button>
      </div>
      <div id="booksList"></div>
    </div>
  </div>

  <div id="editQuoteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="editTitle">‚úèÔ∏è Ch·ªânh S·ª≠a Tr√≠ch D·∫´n</h2>
        <span class="close" onclick="closeEditQuoteModal()" aria-label="ƒê√≥ng">&times;</span>
      </div>
      <div class="control-group">
        <label for="editQuoteText">C√¢u tr√≠ch d·∫´n *</label>
        <textarea id="editQuoteText" required></textarea>
      </div>
      <div class="control-group">
        <label for="editBookName">T√™n s√°ch</label>
        <input type="text" id="editBookName" autocomplete="off" />
      </div>
      <div class="control-group">
        <label for="editCategories">Ch·ªß ƒë·ªÅ (nhi·ªÅu, c√°ch nhau d·∫•u ph·∫©y)</label>
        <input type="text" id="editCategories" placeholder="V√≠ d·ª•: Tri·∫øt h·ªçc, Cu·ªôc s·ªëng" />
      </div>
      <div style="display:flex; gap:10px; margin-top: 6px;">
        <button class="btn btn-primary" onclick="saveEditQuote()">üíæ L∆∞u</button>
        <button class="btn btn-danger" onclick="closeEditQuoteModal()">‚ùå H·ªßy</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // Data & State
    // -----------------------
    let quotes = [];
    let categories = ['Tri·∫øt h·ªçc', 'T√¨nh y√™u', 'Cu·ªôc s·ªëng', 'Th√†nh c√¥ng', 'H·∫°nh ph√∫c', 'H·ªçc t·∫≠p'];
    let books = ['Kh√¥ng r√µ'];
    let currentEditingQuoteId = null;
    let displayedQuotes = [];
    // t·∫°m gi·ªØ ch·ªß ƒë·ªÅ ƒë√£ ch·ªçn ·ªü sidebar khi th√™m m·ªõi
    let sideSelectedCategories = [];

    // -----------------------
    // Utilities
    // -----------------------
    const normalizeVN = (s='') => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim().replace(/\\s+/g, ' ');
    function canonicalize(value, list) {
      const norm = normalizeVN(value);
      const found = list.find(x => normalizeVN(x) === norm);
      return found || (value ? value.trim() : '');
    }
    function addUnique(list, value) {
      const norm = normalizeVN(value);
      if (!value) return;
      const idx = list.findIndex(x => normalizeVN(x) === norm);
      if (idx === -1) list.push(value.trim());
    }
    function slugify(s){ return s.normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-zA-Z0-9-_]+/g,'-').replace(/-+/g,'-').replace(/^-|-$|/g,'').toLowerCase(); }
    function xmlEscape(s=''){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function debounce(func, wait){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>func.apply(null,args), wait); }; }

    // -----------------------
    // Init
    // -----------------------
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      migrateOldQuotesIfNeeded();
      updateStats();
      updateFilters();
      setupEventListeners();
      setupMobileMenu();
      renderSideSelectedCats();
    });

    // -----------------------
    // Responsive Sidebar
    // -----------------------
    function setupMobileMenu() {
      const mobileBtn = document.getElementById('mobileMenuBtn');
      if (window.innerWidth <= 820) { mobileBtn.classList.add('show'); }
      window.addEventListener('resize', function() {
        if (window.innerWidth <= 820) { mobileBtn.classList.add('show'); } else { mobileBtn.classList.remove('show'); closeSidebar(); }
      });
    }
    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('show'); }
    function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobileOverlay').classList.remove('show'); }

    // -----------------------
    // Event Listeners
    // -----------------------
    function setupEventListeners(){
      // t√¨m ki·∫øm
      document.getElementById('searchKeyword').addEventListener('input', debounce(searchQuotes, 300));
      document.getElementById('filterBook').addEventListener('change', searchQuotes);
      document.getElementById('filterCategories').addEventListener('change', searchQuotes);

      // th√™m nhanh v·ªõi Ctrl+Enter
      document.getElementById('sideQuoteText').addEventListener('keydown', function(e){ if (e.ctrlKey && e.key === 'Enter') addQuote(); });

      // th√™m 1 ch·ªß ƒë·ªÅ chip
      document.getElementById('addSideCatBtn').addEventListener('click', function(){
        const val = (document.getElementById('sideCategoryInput').value || '').trim();
        if (!val) return;
        pushSideCategory(val);
      });
      document.getElementById('sideCategoryInput').addEventListener('keydown', function(e){
        if (e.key === 'Enter'){ e.preventDefault(); const val = (this.value||'').trim(); if (val) pushSideCategory(val); }
      });

      // close modal ESC
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeEditQuoteModal(); closeManageBooksModal(); closeManageCategoriesModal(); }});
    }

    function pushSideCategory(val){
      const exists = sideSelectedCategories.some(c => normalizeVN(c) === normalizeVN(val));
      if (!exists){ sideSelectedCategories.push(val); addUnique(categories, val); updateFilters(); }
      document.getElementById('sideCategoryInput').value='';
      renderSideSelectedCats();
    }
    function removeSideCategory(idx){
      sideSelectedCategories.splice(idx,1);
      renderSideSelectedCats();
    }
    function renderSideSelectedCats(){
      const wrap = document.getElementById('sideSelectedCats');
      wrap.innerHTML = '';
      sideSelectedCategories.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.innerHTML = `<span>${c}</span><button title="X√≥a" onclick="removeSideCategory(${i})">√ó</button>`;
        wrap.appendChild(div);
      });
    }

    // -----------------------
    // CRUD Quotes
    // -----------------------
    function addQuote(){
      const text = document.getElementById('sideQuoteText').value.trim();
      let book = document.getElementById('sideBookName').value.trim();
      if (!text){ alert('Vui l√≤ng nh·∫≠p c√¢u tr√≠ch d·∫´n!'); return; }

      book = book || 'Kh√¥ng r√µ';
      // n·∫øu ng∆∞·ªùi d√πng ch∆∞a th√™m chip n√†o, coi nh∆∞ "Ch∆∞a ph√¢n lo·∫°i"
      const cats = sideSelectedCategories.length ? [...sideSelectedCategories] : ['Ch∆∞a ph√¢n lo·∫°i'];
      // chu·∫©n h√≥a theo danh m·ª•c
      const catsCanon = cats.map(c => canonicalize(c, categories) || c);
      catsCanon.forEach(c => addUnique(categories, c));
      book = canonicalize(book, books) || book;
      addUnique(books, book);

      const quote = { id: Date.now(), text, book, categories: catsCanon, createdAt: new Date().toISOString() };
      quotes.push(quote);

      saveData(); updateStats(); updateFilters(); clearForm(); showAllQuotes();
      showNotification('‚úÖ ƒê√£ th√™m tr√≠ch d·∫´n th√†nh c√¥ng!', 'success');
      if (window.innerWidth <= 820) closeSidebar();
    }

    function clearForm(){
      document.getElementById('sideQuoteText').value='';
      document.getElementById('sideBookName').value='';
      document.getElementById('sideCategoryInput').value='';
      sideSelectedCategories = [];
      renderSideSelectedCats();
    }

    function showAllQuotes(){ displayedQuotes = [...quotes]; renderQuotes(); if (window.innerWidth <= 820) closeSidebar(); }

    function showRandomQuotes(){
      if (!quotes.length){ showNotification('‚ö†Ô∏è Ch∆∞a c√≥ c√¢u tr√≠ch d·∫´n n√†o!', 'warning'); return; }
      const shuffled = [...quotes].sort(()=> 0.5 - Math.random());
      displayedQuotes = shuffled.slice(0, Math.min(100, shuffled.length));
      renderQuotes();
      showNotification(`üé≤ Hi·ªÉn th·ªã ${displayedQuotes.length} c√¢u tr√≠ch d·∫´n ng·∫´u nhi√™n`, 'info');
      if (window.innerWidth <= 820) closeSidebar();
    }

    function getSelectedCategoryFilters(){
      const sel = document.getElementById('filterCategories');
      return Array.from(sel.selectedOptions).map(o => o.value).filter(Boolean);
    }

    function searchQuotes(){
      const keyword = normalizeVN(document.getElementById('searchKeyword').value.trim());
      const bookFilter = document.getElementById('filterBook').value;
      const selectedCats = getSelectedCategoryFilters();
      let filtered = quotes;

      if (keyword){
        filtered = filtered.filter(q => {
          const catStr = (q.categories||[]).join(' ');
          return normalizeVN(q.text).includes(keyword)
              || normalizeVN(q.book).includes(keyword)
              || normalizeVN(catStr).includes(keyword);
        });
      }
      if (selectedCats.length){
        filtered = filtered.filter(q => (q.categories||[]).some(cat => selectedCats.includes(cat)));
      }
      if (bookFilter) filtered = filtered.filter(q => q.book === bookFilter);

      displayedQuotes = filtered.slice(0, 200);
      renderQuotes();
      if (keyword || selectedCats.length || bookFilter) showNotification(`üîç T√¨m th·∫•y ${displayedQuotes.length} k·∫øt qu·∫£`, 'info');
      if (window.innerWidth <= 820) closeSidebar();
    }

    // -----------------------
    // Render
    // -----------------------
    function renderQuotes(){
      const grid = document.getElementById('quotesGrid');
      const count = document.getElementById('quotesCount');

      count.textContent = `Hi·ªÉn th·ªã ${displayedQuotes.length} c√¢u tr√≠ch d·∫´n`;

      grid.innerHTML = '';
      if (!displayedQuotes.length){
        const empty = document.createElement('div'); empty.className='empty-state';
        empty.innerHTML = '<div style="font-size:4em; margin-bottom:20px;">üìñ</div><h3>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h3><p>Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc</p>';
        grid.appendChild(empty); return;
      }

      displayedQuotes.forEach(quote => {
        const card = document.createElement('div'); card.className = 'quote-card';
        const actions = document.createElement('div'); actions.className = 'quote-actions';

        const btnEdit = document.createElement('button'); btnEdit.className = 'btn-small btn-primary-small'; btnEdit.title = 'Ch·ªânh s·ª≠a'; btnEdit.textContent = '‚úèÔ∏è';
        btnEdit.addEventListener('click', ()=> editQuote(quote.id));

        const btnDelete = document.createElement('button'); btnDelete.className = 'btn-small btn-danger-small'; btnDelete.title = 'X√≥a'; btnDelete.textContent = 'üóëÔ∏è';
        btnDelete.addEventListener('click', ()=> deleteQuote(quote.id));

        actions.append(btnEdit, btnDelete);

        const text = document.createElement('div'); text.className='quote-text'; text.textContent = `"${quote.text}"`;
        const meta = document.createElement('div'); meta.className='quote-meta';
        const source = document.createElement('div'); source.className='quote-source'; source.textContent = quote.book;

        const catWrap = document.createElement('div');
        (quote.categories||[]).forEach(cat => {
          const c = document.createElement('span');
          c.className = 'quote-category';
          c.textContent = cat;
          catWrap.appendChild(c);
        });

        meta.append(source, catWrap);
        card.append(actions, text, meta);
        grid.appendChild(card);
      });
    }

    function editQuote(id){
      const quote = quotes.find(q => q.id === id); if (!quote) return;
      currentEditingQuoteId = id;
      document.getElementById('editQuoteText').value = quote.text;
      document.getElementById('editBookName').value = quote.book;
      document.getElementById('editCategories').value = (quote.categories||[]).join(', ');
      document.getElementById('editQuoteModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function saveEditQuote(){
      const text = document.getElementById('editQuoteText').value.trim();
      let book = document.getElementById('editBookName').value.trim() || 'Kh√¥ng r√µ';
      const catsStr = document.getElementById('editCategories').value || '';
      const cats = catsStr.split(',').map(s => s.trim()).filter(Boolean);
      const catsCanon = (cats.length ? cats : ['Ch∆∞a ph√¢n lo·∫°i']).map(c => canonicalize(c, categories) || c);

      if (!text){ alert('Vui l√≤ng nh·∫≠p c√¢u tr√≠ch d·∫´n!'); return; }
      const idx = quotes.findIndex(q => q.id === currentEditingQuoteId); if (idx === -1) return;

      book = canonicalize(book, books) || book; addUnique(books, book);
      catsCanon.forEach(c => addUnique(categories, c));

      quotes[idx] = { ...quotes[idx], text, book, categories: catsCanon };
      saveData(); updateStats(); updateFilters(); closeEditQuoteModal(); searchQuotes();
      showNotification('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr√≠ch d·∫´n!', 'success');
    }

    function closeEditQuoteModal(){ document.getElementById('editQuoteModal').style.display = 'none'; document.body.style.overflow=''; currentEditingQuoteId = null; }

    function deleteQuote(id){ if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢u tr√≠ch d·∫´n n√†y?')) return; quotes = quotes.filter(q => q.id !== id); displayedQuotes = displayedQuotes.filter(q => q.id !== id); saveData(); updateStats(); renderQuotes(); showNotification('üóëÔ∏è ƒê√£ x√≥a tr√≠ch d·∫´n!', 'success'); }

    // -----------------------
    // Manage Categories
    // -----------------------
    function openManageCategoriesModal(){ document.getElementById('manageCategoriesModal').style.display='block'; document.body.style.overflow='hidden'; renderCategoriesList(); if (window.innerWidth<=820) closeSidebar(); }
    function closeManageCategoriesModal(){ document.getElementById('manageCategoriesModal').style.display='none'; document.body.style.overflow=''; }

    function addCategory(){
      const name = (document.getElementById('newCategoryName').value || '').trim();
      if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n ch·ªß ƒë·ªÅ!'); return; }
      if (categories.some(c => normalizeVN(c) === normalizeVN(name))) { alert('Ch·ªß ƒë·ªÅ n√†y ƒë√£ t·ªìn t·∫°i!'); return; }
      categories.push(name);
      document.getElementById('newCategoryName').value='';
      renderCategoriesList(); updateFilters(); saveData();
      showNotification('‚úÖ ƒê√£ th√™m ch·ªß ƒë·ªÅ m·ªõi!', 'success');
    }

    function renderCategoriesList(){
      const list = document.getElementById('categoriesList');
      list.innerHTML = '';
      categories.forEach(cat => {
        const item = document.createElement('div'); item.className = 'management-item';
        const span = document.createElement('span'); span.textContent = cat;
        const btn = document.createElement('button'); btn.className='btn btn-danger'; btn.textContent='üóëÔ∏è'; btn.addEventListener('click', ()=> deleteCategory(cat));
        item.append(span, btn); list.appendChild(item);
      });
    }

    function deleteCategory(name){
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ªß ƒë·ªÅ "${name}"?`)) return;
      categories = categories.filter(c => c !== name);
      // lo·∫°i b·ªè ch·ªß ƒë·ªÅ kh·ªèi m·ªçi quote
      quotes = quotes.map(q => ({...q, categories: (q.categories||[]).filter(c => c !== name)}));
      saveData();
      renderCategoriesList(); updateFilters(); showAllQuotes();
      showNotification('üóëÔ∏è ƒê√£ x√≥a ch·ªß ƒë·ªÅ!', 'success');
    }

    // -----------------------
    // Manage Books
    // -----------------------
    function openManageBooksModal(){ document.getElementById('manageBooksModal').style.display='block'; document.body.style.overflow='hidden'; renderBooksList(); if (window.innerWidth<=820) closeSidebar(); }
    function closeManageBooksModal(){ document.getElementById('manageBooksModal').style.display='none'; document.body.style.overflow=''; }

    function addBook(){
      const name = (document.getElementById('newBookName').value || '').trim();
      if (!name) { alert('Vui l√≤ng nh·∫≠p t√™n s√°ch!'); return; }
      if (books.some(b => normalizeVN(b) === normalizeVN(name))) { alert('S√°ch n√†y ƒë√£ t·ªìn t·∫°i!'); return; }
      books.push(name);
      document.getElementById('newBookName').value='';
      renderBooksList(); updateFilters(); saveData();
      showNotification('‚úÖ ƒê√£ th√™m s√°ch m·ªõi!', 'success');
    }

    function renderBooksList(){
      const list = document.getElementById('booksList');
      list.innerHTML = '';
      books.forEach(book => {
        const item = document.createElement('div'); item.className = 'management-item';
        const span = document.createElement('span'); span.textContent = book;
        const btn = document.createElement('button'); btn.className='btn btn-danger'; btn.textContent='üóëÔ∏è'; btn.addEventListener('click', ()=> deleteBook(book));
        item.append(span, btn); list.appendChild(item);
      });
    }

    function deleteBook(name){ if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√°ch "${name}"?`)) return; books = books.filter(b => b !== name); renderBooksList(); updateFilters(); saveData(); showNotification('üóëÔ∏è ƒê√£ x√≥a s√°ch!', 'success'); }

    // -----------------------
    // Filters & Stats
    // -----------------------
    function updateFilters(){
      // c·∫≠p nh·∫≠t danh s√°ch ch·ªß ƒë·ªÅ cho multi-select
      const catSelect = document.getElementById('filterCategories');
      const selectedBefore = Array.from(catSelect.selectedOptions).map(o => o.value);
      catSelect.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat; option.textContent = cat;
        if (selectedBefore.includes(cat)) option.selected = true;
        catSelect.appendChild(option);
      });

      // c·∫≠p nh·∫≠t s√°ch
      const bookSelect = document.getElementById('filterBook');
      const currentBookValue = bookSelect.value; bookSelect.innerHTML = '<option value="">T·∫•t c·∫£ s√°ch</option>';
      books.forEach(book => { const option = document.createElement('option'); option.value = book; option.textContent = book; if (book === currentBookValue) option.selected = true; bookSelect.appendChild(option); });
    }

    function updateStats(){
      document.getElementById('totalQuotes').textContent = quotes.length;
      document.getElementById('totalCategories').textContent = categories.length;
      document.getElementById('totalBooks').textContent = books.length;
    }

    // -----------------------
    // Export / Import XML (h·ªó tr·ª£ nhi·ªÅu ch·ªß ƒë·ªÅ)
    // -----------------------
    function exportXMLData(){
      try{
        const xmlParts = [];
        xmlParts.push(`<QuotesApp version="2.0" exportDate="${new Date().toISOString()}">`);
        xmlParts.push(`<Quotes>`);
        quotes.forEach(q => {
          xmlParts.push(`<Quote id="${q.id}">`);
          xmlParts.push(`<Text>${xmlEscape(q.text)}</Text>`);
          xmlParts.push(`<Book>${xmlEscape(q.book)}</Book>`);
          xmlParts.push(`<Categories>`);
          (q.categories||['Ch∆∞a ph√¢n lo·∫°i']).forEach(c => xmlParts.push(`<Category>${xmlEscape(c)}</Category>`));
          xmlParts.push(`</Categories>`);
          xmlParts.push(`<CreatedAt>${xmlEscape(q.createdAt || '')}</CreatedAt>`);
          xmlParts.push(`</Quote>`);
        });
        xmlParts.push(`</Quotes>`);
        xmlParts.push(`<CategoriesList>`);
        categories.forEach(c => xmlParts.push(`<Category>${xmlEscape(c)}</Category>`));
        xmlParts.push(`</CategoriesList>`);
        xmlParts.push(`<Books>`);
        books.forEach(b => xmlParts.push(`<Book>${xmlEscape(b)}</Book>`));
        xmlParts.push(`</Books>`);
        xmlParts.push(`</QuotesApp>`);

        const xmlString = xmlParts.join('');
        const blob = new Blob([xmlString], { type: 'application/xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${slugify('trich-dan-backup')}-${new Date().toISOString().slice(0,10)}.xml`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(()=> URL.revokeObjectURL(url), 200);
        showNotification('üíæ ƒê√£ xu·∫•t XML th√†nh c√¥ng!', 'success');
        if (window.innerWidth <= 820) closeSidebar();
      } catch(e){ console.error('L·ªói xu·∫•t XML:', e); showNotification('‚ùå L·ªói xu·∫•t XML: ' + e.message, 'error'); }
    }

    function importXMLData(event){
      const file = event.target.files[0]; if (!file) return;
      if (!file.name.toLowerCase().endsWith('.xml')) { alert('Vui l√≤ng ch·ªçn file XML!'); event.target.value=''; return; }
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const xmlString = e.target.result;
          const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlString, 'application/xml');
          const parseError = xmlDoc.querySelector('parsererror'); if (parseError) throw new Error('File XML kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
          const root = xmlDoc.querySelector('QuotesApp'); if (!root) throw new Error('File XML kh√¥ng ƒë√∫ng c·∫•u tr√∫c QuotesApp');

          const newQuotes = [];
          xmlDoc.querySelectorAll('Quotes > Quote').forEach(qEl => {
            const id = parseInt(qEl.getAttribute('id')) || Date.now() + Math.random();
            const text = qEl.querySelector('Text')?.textContent || '';
            const book = qEl.querySelector('Book')?.textContent || 'Kh√¥ng r√µ';
            // h·ªó tr·ª£ c·∫£ format c≈© (<Category>) l·∫´n m·ªõi (<Categories><Category>..)
            let cats = [];
            const multiCats = qEl.querySelectorAll('Categories > Category');
            if (multiCats.length){
              multiCats.forEach(cEl => { const v = (cEl.textContent||'').trim(); if (v) cats.push(v); });
            } else {
              const catOld = qEl.querySelector('Category')?.textContent || 'Ch∆∞a ph√¢n lo·∫°i';
              if (catOld) cats = [catOld];
            }
            const createdAt = qEl.querySelector('CreatedAt')?.textContent || new Date().toISOString();
            if (text) newQuotes.push({ id, text, book, categories: cats.length?cats:['Ch∆∞a ph√¢n lo·∫°i'], createdAt });
          });

          // danh m·ª•c t·ªïng th·ªÉ
          let newCategories = [];
          const catsBlock = xmlDoc.querySelectorAll('CategoriesList > Category');
          if (catsBlock.length){
            catsBlock.forEach(cEl => { const val = (cEl.textContent || '').trim(); if (val && !newCategories.some(x => normalizeVN(x)===normalizeVN(val))) newCategories.push(val); });
          } else {
            // fallback theo format c≈©
            xmlDoc.querySelectorAll('Categories > Category').forEach(cEl => { const val = (cEl.textContent || '').trim(); if (val && !newCategories.some(x => normalizeVN(x)===normalizeVN(val))) newCategories.push(val); });
          }
          const newBooks = [];
          xmlDoc.querySelectorAll('Books > Book').forEach(bEl => { const val = (bEl.textContent || '').trim(); if (val && !newBooks.some(x => normalizeVN(x)===normalizeVN(val))) newBooks.push(val); });

          const confirmMessage = `B·∫°n c√≥ mu·ªën thay th·∫ø d·ªØ li·ªáu hi·ªán t·∫°i kh√¥ng?\n\nHi·ªán t·∫°i: ${quotes.length} c√¢u tr√≠ch d·∫´n\nT·ª´ file XML: ${newQuotes.length} c√¢u tr√≠ch d·∫´n\n\nL∆∞u √Ω: D·ªØ li·ªáu c≈© s·∫Ω b·ªã ghi ƒë√®!`;
          if (confirm(confirmMessage)){
            // Chu·∫©n h√≥a book/category theo danh m·ª•c m·ªõi ƒë·ªÉ tr√°nh l·ªách t√™n
            quotes = newQuotes.map(q=> ({
              ...q,
              book: canonicalize(q.book, newBooks) || q.book,
              categories: (q.categories||[]).map(c => canonicalize(c, newCategories) || c)
            }));
            categories = newCategories.length ? newCategories : ['Tri·∫øt h·ªçc','T√¨nh y√™u','Cu·ªôc s·ªëng','Th√†nh c√¥ng','H·∫°nh ph√∫c','H·ªçc t·∫≠p'];
            books = newBooks.length ? newBooks : ['Kh√¥ng r√µ'];
            saveData(); updateStats(); updateFilters(); showAllQuotes();
            showNotification(`üìÅ ƒê√£ nh·∫≠p th√†nh c√¥ng ${quotes.length} c√¢u tr√≠ch d·∫´n t·ª´ XML!`, 'success');
            if (window.innerWidth <= 820) closeSidebar();
          }
        } catch(e){ console.error('L·ªói ƒë·ªçc file XML:', e); alert('L·ªói ƒë·ªçc file XML: ' + e.message); }
        event.target.value = '';
      };
      reader.onerror = function(){ alert('L·ªói ƒë·ªçc file!'); event.target.value = ''; };
      reader.readAsText(file, 'UTF-8');
    }

    // -----------------------
    // Export / Import TXT (h·ªó tr·ª£ nhi·ªÅu ch·ªß ƒë·ªÅ)
    // -----------------------
    function exportTXTData(){
      if (!displayedQuotes.length){ alert('Kh√¥ng c√≥ c√¢u tr√≠ch d·∫´n n√†o ƒë·ªÉ xu·∫•t!'); return; }
      try{
        let content = `T·ªîNG H·ª¢P C√ÇU TR√çCH D·∫™N\n`;
        content += `Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}\n`;
        content += `T·ªïng s·ªë: ${displayedQuotes.length} c√¢u tr√≠ch d·∫´n\n`;
        content += `${'='.repeat(50)}\n\n`;
        content += displayedQuotes.map((q,i)=> `${i+1}. "${q.text}"\n   - ${q.book} (${(q.categories||[]).join(', ')})\n`).join('\n');
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `trich-dan-hien-thi-${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(()=> URL.revokeObjectURL(url), 200);
        showNotification('üìë ƒê√£ xu·∫•t TXT (hi·ªÉn th·ªã) th√†nh c√¥ng!', 'success'); if (window.innerWidth <= 820) closeSidebar();
      } catch(e){ console.error('L·ªói xu·∫•t TXT:', e); showNotification('‚ùå L·ªói xu·∫•t TXT: ' + e.message, 'error'); }
    }

    function exportTXTFullData(){
      if (!quotes.length){ alert('Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë·ªÉ xu·∫•t!'); return; }
      try{
        let content = `BACKUP TO√ÄN B·ªò D·ªÆ LI·ªÜU TR√çCH D·∫™N\n`;
        content += `Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}\n`;
        content += `T·ªïng s·ªë: ${quotes.length} c√¢u tr√≠ch d·∫´n, ${categories.length} ch·ªß ƒë·ªÅ, ${books.length} s√°ch\n`;
        content += `${'='.repeat(60)}\n\n`;
        content += `[Quotes]\n`;
        quotes.forEach((q,i)=>{ content += `${i+1}|"\\${q.text.replace(/"/g,'\\"')}"|\${q.book}|\${(q.categories||[]).join(', ')}\n`; });
        content += `\n[Categories]\n`; categories.forEach(c=> content += `${c}\n`);
        content += `\n[Books]\n`; books.forEach(b=> content += `${b}\n`);
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `backup-toan-bo-${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(()=> URL.revokeObjectURL(url), 200);
        showNotification('üìÑ ƒê√£ xu·∫•t TXT to√†n b·ªô th√†nh c√¥ng!', 'success'); if (window.innerWidth <= 820) closeSidebar();
      } catch(e){ console.error('L·ªói xu·∫•t TXT to√†n b·ªô:', e); showNotification('‚ùå L·ªói xu·∫•t TXT to√†n b·ªô: ' + e.message, 'error'); }
    }

    function importTXTData(event){
      const file = event.target.files[0]; if (!file) return;
      if (!file.name.toLowerCase().endsWith('.txt')){ alert('Vui l√≤ng ch·ªçn file TXT ƒë√∫ng ƒë·ªãnh d·∫°ng!'); event.target.value=''; return; }
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const lines = e.target.result.split(/\r?\n/);
          let newQuotes = [], newCategories = [], newBooks = [], section = '';
          lines.forEach(raw => {
            let line = (raw||'').trim(); if (!line) return;
            if (line.startsWith('[') && line.endsWith(']')){ section = line; return; }
            if (section === '[Quotes]'){
              const parts = line.split('|');
              if (parts.length >= 4){
                const text = parts[1].replace(/^"|"$/g,'').replace(/\\"/g,'"');
                const book = parts[2];
                const catStr = parts[3];
                const cats = catStr.split(',').map(s => s.trim()).filter(Boolean);
                if (text) newQuotes.push({ id: Date.now()+Math.random(), text, book, categories: cats.length?cats:['Ch∆∞a ph√¢n lo·∫°i'], createdAt: new Date().toISOString() });
              }
            } else if (section === '[Categories]'){
              if (line && !newCategories.some(x => normalizeVN(x)===normalizeVN(line))) newCategories.push(line);
            } else if (section === '[Books]'){
              if (line && !newBooks.some(x => normalizeVN(x)===normalizeVN(line))) newBooks.push(line);
            }
          });
          const confirmMessage = `B·∫°n c√≥ mu·ªën thay th·∫ø d·ªØ li·ªáu hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu t·ª´ file TXT?\n\nHi·ªán t·∫°i: ${quotes.length} tr√≠ch d·∫´n, ${categories.length} ch·ªß ƒë·ªÅ, ${books.length} s√°ch\nT·ª´ file TXT: ${newQuotes.length} tr√≠ch d·∫´n, ${newCategories.length} ch·ªß ƒë·ªÅ, ${newBooks.length} s√°ch\n\nL∆∞u √Ω: D·ªØ li·ªáu c≈© s·∫Ω b·ªã ghi ƒë√®!`;
          if (confirm(confirmMessage)){
            quotes = newQuotes.map(q=> ({ ...q, book: canonicalize(q.book, newBooks)||q.book, categories: (q.categories||[]).map(c => canonicalize(c, newCategories)||c) }));
            categories = newCategories.length ? newCategories : ['Tri·∫øt h·ªçc','T√¨nh y√™u','Cu·ªôc s·ªëng','Th√†nh c√¥ng','H·∫°nh ph√∫c','H·ªçc t·∫≠p'];
            books = newBooks.length ? newBooks : ['Kh√¥ng r√µ'];
            saveData(); updateStats(); updateFilters(); showAllQuotes();
            showNotification(`üìÅ ƒê√£ nh·∫≠p th√†nh c√¥ng ${quotes.length} c√¢u tr√≠ch d·∫´n t·ª´ TXT!`, 'success');
            if (window.innerWidth <= 820) closeSidebar();
          }
        } catch(e){ console.error('L·ªói ƒë·ªçc file TXT:', e); alert('L·ªói ƒë·ªçc file TXT: ' + e.message); }
        event.target.value = '';
      };
      reader.onerror = function(){ alert('L·ªói ƒë·ªçc file!'); event.target.value=''; };
      reader.readAsText(file, 'UTF-8');
    }

    // -----------------------
    // Storage
    // -----------------------
    function saveData(){
      try{
        localStorage.setItem('quotesApp_quotes', JSON.stringify(quotes));
        localStorage.setItem('quotesApp_categories', JSON.stringify(categories));
        localStorage.setItem('quotesApp_books', JSON.stringify(books));
        localStorage.setItem('quotesApp_lastSave', new Date().toISOString());
      } catch(e){ console.error('L·ªói l∆∞u d·ªØ li·ªáu:', e); showNotification('‚ùå L·ªói l∆∞u d·ªØ li·ªáu: ' + e.message, 'error'); }
    }

    function loadData(){
      try{
        const savedQuotes = localStorage.getItem('quotesApp_quotes');
        const savedCategories = localStorage.getItem('quotesApp_categories');
        const savedBooks = localStorage.getItem('quotesApp_books');
        if (savedQuotes){ const parsed = JSON.parse(savedQuotes); if (Array.isArray(parsed)) quotes = parsed; }
        if (savedCategories){ const parsed = JSON.parse(savedCategories); if (Array.isArray(parsed)) categories = parsed; }
        if (savedBooks){ const parsed = JSON.parse(savedBooks); if (Array.isArray(parsed)) books = parsed; }
        showAllQuotes();
      } catch(e){ console.error('L·ªói t·∫£i d·ªØ li·ªáu:', e); showNotification('‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu ƒë√£ l∆∞u', 'warning'); }
    }

    // chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu c≈© (quote.category -> quote.categories[])
    function migrateOldQuotesIfNeeded(){
      let changed = false;
      quotes = quotes.map(q => {
        if (q && !q.categories){
          const cat = q.category || 'Ch∆∞a ph√¢n lo·∫°i';
          changed = true;
          const rest = {...q}; delete rest.category;
          return { ...rest, categories: [cat] };
        }
        return q;
      });
      if (changed) saveData();
    }

    // -----------------------
    // Clear all
    // -----------------------
    function clearAllData(){
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu?')) return;
      quotes = []; categories = ['Tri·∫øt h·ªçc', 'T√¨nh y√™u', 'Cu·ªôc s·ªëng', 'Th√†nh c√¥ng', 'H·∫°nh ph√∫c', 'H·ªçc t·∫≠p']; books = ['Kh√¥ng r√µ'];
      saveData(); updateStats(); updateFilters(); showAllQuotes();
      showNotification('üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!', 'success');
    }

    // -----------------------
    // Notifications
    // -----------------------
    function showNotification(message, type='info'){
      const n = document.createElement('div');
      n.style.cssText = `position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 16px; border-radius: 8px; color: white; font-weight: 600; z-index: 10000; max-width: 420px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: opacity 0.3s ease;`;
      const colors = { success: '#c8e6c9', error: '#ffcdd2', warning: '#ffe0b2', info: '#e1f5fe' };
      const textColors = { success: '#2e7d32', error: '#c62828', warning: '#e65100', info: '#0277bd' };
      n.style.backgroundColor = colors[type] || colors.info; n.style.color = textColors[type] || textColors.info; n.textContent = message;
      document.body.appendChild(n); setTimeout(()=> n.style.opacity='1', 10); setTimeout(()=> { n.style.opacity='0'; setTimeout(()=> n.remove(), 300); }, 2500);
    }
  </script>
</body>
</html>